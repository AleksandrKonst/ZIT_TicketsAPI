# TicketsAPI
Вариации реализации:
| Репозиторий | Описание  |
| ------------ | ------------ |
| TicketsAPI | реализация без репозиториев, только с сервисами `(Controller-Serviece-DataBase)`|
| TicketsAPI-Repo  | реализация с асинхронными репозиториями `(Controller-Serviece-Repository-DataBase)`|
|  TicketsAPI-Unit-Repo |  реализация с асинхронными репозиториями, через паттерн Unit of Work `(Controller-Serviece-UnitOfWork-Repository-DataBase)`|
# Тестовый JSON
```json
{
    "operation_type": "sale",
    "operation_time": "2022-01-02T03:25+03:00",
    "operation_place": "Pobeda",
    "passenger": {
        "name": "Aleksandr",
        "surname": "Alexsandr",
        "patronymic": "Alexsandrovich",
        "doc_type": "00",
        "doc_number": "3108111446",
        "birthdate": "2002-12-11",
        "gender": "M",
        "passenger_type": "youth",
        "ticket_number": "5552139265678",
        "ticket_type": 1
    },
    "routes": [{
            "airline_code": "SU",
            "flight_num": 1713,
            "depart_place": "AAQ",
            "depart_datetime": "2022-01-03T09:20+10:00",
            "arrive_place": "NSK",
            "arrive_datetime": "2022-01-03T11:25+03:00",
            "pnr_id": "THALSZ"
        }, {
            "airline_code": "SU",
            "flight_num": 1714,
            "depart_place": "NSK",
            "depart_datetime": "2022-01-08T16:10+03:00",
            "arrive_place": "AAQ",
            "arrive_datetime": "2022-01-08T07:40+10:00",
            "pnr_id": "THALSZ"
        }
    ]
}
```
# Задание
Нужно написать сервис, решающий такую задачу: по HTTP приходят сведения о продажах и возвратах авиабилетов. Необходимо сохранять информацию в базе данных с возвратом кодов операций.
Сервис должен представлять собой self-hosted веб-сервер, написанный на C#.

Сервис должен принимать запросы на префиксе http://+:8080/, например http://localhost:8080/sale или http://localhost:8080/refund

### API
Продажа билета: POST /process/sale/
Body: JSON-файл следующего вида (один файл соответствует одному билету, в котором указан маршрут, состоящий из нескольких сегментов-перелетов):
```json
{
    "operation_type": "sale",
    "operation_time": "2022-01-01T03:25+03:00",
    "operation_place": "Aeroflot",
    "passenger": {
        "name": "Dmitrii",
        "surname": "Makarov",
        "patronymic": "Pavlovich",
        "doc_type": "00",
        "doc_number": "3108111434",
        "birthdate": "2001-07-12",
        "gender": "M",
        "passenger_type": "youth",
        "ticket_number": "5552139265672",
        "ticket_type": 1
    },
    "routes": [{
            "airline_code": "SU",
            "flight_num": 1701,
            "depart_place": "AAQ",
            "depart_datetime": "2022-01-02T09:20+10:00",
            "arrive_place": "NSK",
            "arrive_datetime": "2022-01-02T11:25+03:00",
            "pnr_id": "THALSZ"
        }, {
            "airline_code": "SU",
            "flight_num": 1702,
            "depart_place": "NSK",
            "depart_datetime": "2022-01-05T16:10+03:00",
            "arrive_place": "AAQ",
            "arrive_datetime": "2022-01-05T07:40+10:00",
            "pnr_id": "THALSZ",
        }
    ]
}
```

Возврат билета: POST /process/refund/
Body: JSON-файл следующего вида (при сдаче билета следует пометить как сданные все его сегменты):
```json    
{
    "operation_type": "refund",
    "operation_time": "2022-01-01T03:25+03:00",
    "operation_place": "Aeroflot",
    "ticket_number": "5552139265672"
}
```
### Проверка входных данных
Необходимо разработать две JSON-схемы для проверки поступающих JSON-файлов
(https://json-schema.org/) 

Если JSON не соответствует JSON-схеме, то нужно отправить пустой ответ с кодом 400 Bad Request.
Помимо проверки на соответствие JSON-схеме, значения элементов входных файлов должны соответствовать следующим ограничениям:
-	номер билета (ticket_number) должен состоять из 13 цифр
-	пол (gender) может принимать значения F, M
-	если тип документа (doc_type) равен 00, то номер документа (doc_number) должен состоять из 10 цифр

Таким образом, должен быть разработан внутренний валидатор значений, при нарушении любого из правил валидации должен возвращаться код завершения 400 Bad Request.
Если размер JSON превышает 2 килобайта, то необходимо возвращать HTTP код 413

При успешной обработке необходимо возвращать HTTP код 200.

### Обработка запросов
Необходимо спроектировать схему базы данных под управлением PostgreSQL, состоящую из одной таблицы segments, в которой каждая запись будет соответствовать одному сегменту. Т.е. при обработке одной операции sale в таблице segments может появиться несколько записей (по числу сегментов).
Для базы данных следует использовать подход Code First (то есть схема базы данных должна генерироваться автоматически по модели в C#-коде). При этом ключи, индексы и ограничения целостности должны быть определены в модели.
При работе с базой данных следует использовать EntityFramework.
Для хранения дат в базе данных должны использоваться пары столбцов: 
operation_time timestamp with time zone,          -- для дат в UTC
operation_time_timezone smallint                       -- для временной зоны

Работать с датами следующим образом (на примере 2016-01-01 14:01:02+04):
-	при вставке ничего не пересчитывать в C#-коде, пересчитает PostgreSQL в UTC автоматически сам (то есть вставлять 2016-01-01 14:01:02+04, в базу ляжет UTC 2016-01-01 10:01:02)
-	сохранять временную зону в формате POSIX в отдельный столбец (-04)
-	при обработке если есть необходимость выдать дату в оригинальном виде, то выполнять преобразование в SQL-запросах с помощью SQL-конструкции at time zone <столбец_зоны>

Для операции refund для всех сегментов из маршрута билета с переданным номером должен проставляться признак «сдан». 
Должна предусматриваться обработка ситуаций:
-	повторная продажа билета (с одинаковым номером)
-	сдача отсутствующего билета (с отсутствующим номером)
-	повторная сдача билета (для сегментов которого выставлен признак «сдан»)
Во всех этих случаях должен возвращаться код HTTP 409.
В том случае, если обработка hhtp-запроса превышает заданное время (120 секунд – в настройках), то выдавать код завершения 408.
Для тестирования сервиса можно использовать Postman (https://www.postman.com/).
### Работа с транзакциями
Неправильно написанный код в стиле:
-	SQL-запросом проверили существование записей по номеру билета
-	если нет записей с таким номером билета, то вставляем в таблицу записи про новые сегменты
может привести к появлению дубликатов билетов или успешным повторным сдачам.
Для корректной работы с транзакциями надо использовать механизм блокировок СУБД PostgreSQL. Необходимо в таблицу сегментов добавить:
- столбец serial_number (порядковый номер сегмента в билете (1, 2, 3..))
- ограничение (unique constraint) на уникальность пары (ticket_number, serial_number)

При вставке каждого билета начинать транзакцию BEGIN, в цикле вставлять записи в таблицу сегментов. Если билет с таким номером в таблице уже есть, то при вставке 
первой же записи (с serial_number 1) произойдет ошибка нарушения уникальности. 
Ее надо обработать и выдать соответствующий код 409.

Более подробное описание работы с транзакциями содержится в Типовых замечаниях в последнем пункте.
 
### Первый этап
На первом этапе необходима разработать монолитное приложение, пройти code review (перед сдачей на review следует ознакомиться с актуальным файлом Типовые замечания по тестовому заданию Tickets.txt) и устранить все возникшие дополнительные замечания.

Проект должен быть оформлен в виде репозитория на Github.

Собственно тестовое задание заключается в прохождении первого этапа. По итогам ознакомления с репозиторием, формирования списка замечаний, их устранения и собеседования принимается решение о приеме на практику на позицию C# junior developer.

Второй этап выполняется уже в ходе прохождения практики.

